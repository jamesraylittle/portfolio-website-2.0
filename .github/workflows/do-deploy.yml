name: 'Deploy to jameslittle.org'
concurrency: production

on:
  push:
    branches:
      - release/*
  workflow_dispatch:
      
jobs:

  deployment:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Set Variables
        uses: allenevans/set-env@v2.0.0
        with:
          OVPN: ${{secrets.OVPN_GITHUB}}
          SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
          SSH_KNOWN_HOSTS: ${{secrets.SSH_KNOWN_HOSTS}}
          SSH_USERNAME: ${{secrets.SSH_USERNAME}}
          SSH_PORT: ${{secrets.SSH_PORT}}
          SSH_HOST: ${{secrets.HOST}}
          
      - name: Create SSH key
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          
      - name: Write VPN Files
        run: |
          mkdir -p ~/.ssh
          echo "$OVPN" > .github/vpn.ovpn
          
      - name: Install Open VPN
        run: |
          git remote add deploy $DEPLOY_URL
          sudo apt install apt-transport-https
          sudo wget https://swupdate.openvpn.net/repos/openvpn-repo-pkg-key.pub
          sudo apt-key add openvpn-repo-pkg-key.pub
          sudo wget -O /etc/apt/sources.list.d/openvpn3.list https://swupdate.openvpn.net/community/openvpn3/repos/openvpn3-bionic.list
          sudo apt update
          sudo apt install openvpn3
          
      - name: Start Open VPN 3
        run: |
          { echo user ; } | openvpn3 session-start --config .github/vpn.ovpn
      - name: SSH & Run Script
        run: |
          ssh $SSH_USERNAME@$SSH_HOST -p$SSH_PORT '~/.gh-update.sh'
